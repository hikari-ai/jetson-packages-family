version: 2.1

parameters:
  ghcr_registry:
    type: string
    default: ghcr.io
  ghcr_username:
    type: string
    default: hikari-ai
  heroku_registry:
    type: string
    default: registry.heroku.com

  image:
    type: string
    default: jetson-packages-family
  tag:
    type: string
    default: latest

jobs:
  build-and-push:
    machine: true
    steps:
      - checkout
      - run:
          name: Synchronize git submodule
          command: git submodule update --init --recursive
      - run:
          name: Login to Container Registries
          command: |
            docker login <<pipeline.parameters.ghcr_registry>> -u <<pipeline.parameters.ghcr_username>> -p $DOCKER_PASSWORD
            docker login <<pipeline.parameters.heroku_registry>> -u $HEROKU_USERNAME -p $HEROKU_TOKEN
      - run:
          name: Build and Tag Images
          command: |
            docker build -t base .
            docker tag base <<pipeline.parameters.ghcr_registry>>/<<pipeline.parameters.ghcr_username>>/<<pipeline.parameters.image>>:<<pipeline.parameters.tag>>
            docker tag base <<pipeline.parameters.heroku_registry>>/<<pipeline.parameters.image>>/web
      - run:
          name: Push Images
          command: |
            docker push <<pipeline.parameters.ghcr_registry>>/<<pipeline.parameters.ghcr_username>>/<<pipeline.parameters.image>>:<<pipeline.parameters.tag>>
            docker push <<pipeline.parameters.heroku_registry>>/<<pipeline.parameters.image>>/web

workflows:
  build-and-publish-image:
    jobs:
      - build-and-push:
          context: secrets
